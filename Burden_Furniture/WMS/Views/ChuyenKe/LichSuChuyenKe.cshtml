@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .dx-header-row {
        background-color: #005180;
        color: #ffff;
    }
</style>
@section Header{
    <div class="nk-block-head-content">
        <h3 class="nk-block-title page-title">@Resources.Menu.LichSuChuyenKe</h3>
    </div>
    @*<div class="nk-block-head-content">
        <div class="toggle-wrap nk-block-tools-toggle">
            <a href="#" class="btn btn-icon btn-trigger toggle-expand mr-n1" data-target="pageMenu"><em class="icon ni ni-more-v"></em></a>
            <div class="toggle-expand-content" data-content="pageMenu">
                <ul class="nk-block-tools g-3">
                    <li>
                        <a href="#" class="btn btn-white btn-dim btn-outline-primary" onclick="ExportXLS()"><em class="icon ni ni-download-cloud"></em><span>@Resources.Main.XuatFile</span></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>*@

}
<div class="nk-block">
    <div class="card card-bordered card-stretch">
        <div class="card-inner-group">
            <div class="card-inner position-relative ">
                <div class="row justify-content-center">
                    <div class="col-lg-3 col-sm-3">
                        <div class="form-group">
                            <label class="overline-title overline-title-alt form-label">@Resources.Main.NguoiDung</label>
                            <div id="select-nguoidung">

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <div class="form-group">
                            <label class="overline-title overline-title-alt form-label">Mã SP</label>
                            <div id="txt-masp">

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <div class="form-group">
                            <label class="overline-title overline-title-alt form-label">Mã SKU</label>
                            <div id="txt-masku">

                            </div>
                        </div>
                    </div>
                    
                </div>
                <div class="row justify-content-center">
                    <div class="col-lg-3 col-sm-3">
                        <div class="form-group">
                            <label class="overline-title overline-title-alt form-label">@Resources.Main.TuNgay</label>
                            <div id="date-tungay">

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <div class="form-group">
                            <label class="overline-title overline-title-alt form-label">@Resources.Main.DenNgay</label>
                            <div id="date-denngay">

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <label class="overline-title overline-title-alt form-label text-white">@Resources.Main.TimKiem</label>
                        <div class="form-group "><button type="button" class="btn btn-secondary" onclick="Refresh()">@Resources.Main.TimKiem</button></div>
                    </div>
                </div>
            </div>
            <div class="card-inner p-0">
                <div id="gridContainer"></div>
            </div>

        </div>
    </div>
</div>
<div class="loadpanel"></div>
@section CustomScripts{
<script type="text/javascript">
    var date = new Date();
    var masku = null;
    var masp = null;
    var tungay = Globalize.format(new Date(date.getFullYear(), date.getMonth(), 1), "yyyy-MM-dd"),
        denngay = Globalize.format(new Date(date.getFullYear(), date.getMonth(), date.getDate()), "yyyy-MM-dd"), NguoiChuyen = null;
    var loadPanel = $(".loadpanel").dxLoadPanel({
        shadingColor: "rgba(0,0,0,0.4)",
        visible: false,
        showIndicator: true,
        showPane: true,
        shading: true,
        message: 'Loading..',
        closeOnOutsideClick: false,
    }).dxLoadPanel("instance");
    $(function () {
        $("#txt-masku").dxTextBox({
            placeholder: "Nhập mã SKU"
        });
        $("#txt-masp").dxTextBox({
            placeholder: "Nhập mã SP"
        });
        $('#danh-sach').height($(window).height() - 250);
        $("#date-tungay").dxDateBox({
            value: new Date(date.getFullYear(), date.getMonth(), 1),
            width: '100%',
            displayFormat: 'dd/MM/yyyy',
            onValueChanged: function (data) {
                tungay = Globalize.format(data.value, "yyyy-MM-dd");
            },
        }).dxDateBox("instance");
        $("#date-denngay").dxDateBox({
            value: date,
            width: '100%',
            displayFormat: 'dd/MM/yyyy',
            onValueChanged: function (data) {
                denngay = Globalize.format(data.value, "yyyy-MM-dd");
            },
        }).dxDateBox("instance");

        
         $.get('@Url.Action("GetNguoiDung", "Data")', function (rs) {
            $("#select-nguoidung").dxDropDownBox({
                dataSource: new DevExpress.data.ArrayStore({ key: "IdNguoiDung", data: rs }),
                valueExpr: "IdNguoiDung",
                deferRendering: false,
                placeholder: "Chọn người chuyển...",
                displayExpr: function (item) {
                    return " [" + item.TaiKhoan + "] " + item.HoTen;
                },
                showClearButton: true,
                onOpened: function (e) {
                    var drw = 550;
                    var popupInstance = e.element.find(".dx-popup").dxPopup("instance"); popupInstance.option('width', drw); popupInstance.off("optionChanged", optionChangedHandler); popupInstance.on("optionChanged", optionChangedHandler); function optionChangedHandler(args) { if (args.name == "width" && args.value < drw) { args.component.option("width", drw); } } e.component.getDataSource().reload();
                },
                contentTemplate: function (e) {
                    var value = e.component.option("value"),
                        $dataGrid = $("<div>").dxDataGrid({
                            dataSource: e.component.getDataSource(),
                            filterRow: {
                                visible: true,
                                applyFilter: "auto"
                            },
                            columns: [{ dataField: 'TaiKhoan', caption: 'Tài Khoản' }, { dataField: 'HoTen', caption: 'HoTen' }],
                            hoverStateEnabled: true, pager: { showPageSizeSelector: true, showInfo: true }, rowAlternationEnabled: true, showBorders: true, hoverStateEnabled: false, allowColumnReordering: true, allowColumnResizing: true, columnAutoWidth: true, selection: { mode: "single" }, selectedRowKeys: [value], height: "100%",
                            onSelectionChanged: function (selectedItems) {
                                var keys = selectedItems.selectedRowKeys, hasSelection = keys.length; e.component.option("value", hasSelection ? keys[0] : null); if (hasSelection) { e.component.close(); }
                            }});
                    dataGrid = $dataGrid.dxDataGrid("instance");
                    e.component.on("valueChanged", function (args) {
                        dataGrid.selectRows(args.value, false);
                    });
                    return $dataGrid;
                }
             });
        });
        loadReport();

    });
    function loadReport() {
        var data = {};
        data.TuNgay = tungay;
        data.DenNgay = denngay;
        data.MaSKU = masku;
        data.MaSP = masp;
        data.NguoiChuyen = NguoiChuyen;
        $.get("@Url.Action("getLichSuChuyenKe","ChuyenKe")",data).done(function (rs) {
            $("#gridContainer").dxDataGrid({
                dataSource: rs.data,
                remoteOperations: {
                    paging: true,
                    filtering: true
                },
                filterRow: {
                    visible: true,
                    applyFilter: "auto"
                },
                paging: {
                    pageSize: 10
                },
                export: {
                    enabled: true,
                    fileName: "Lịch Sử Chuyển Kệ Hàng Trắng",
                },
                showRowLines: true,
                rowAlternationEnabled: true,
                showBorders: true,
                hoverStateEnabled: true,
                allowColumnReordering: true,
                allowColumnResizing: true,
                columnAutoWidth: true,
                onRowUpdating: function (e) {
                    for (var property in e.oldData) {
                        if (!e.newData.hasOwnProperty(property)) {
                            e.newData[property] = e.oldData[property];
                        }
                    }
                    updatedObject = e.newData;
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 15, 20, 50, 100],
                    showInfo: true
                },
                columnFixing: {
                    enabled: false
                },
                columns: [
                    { dataField: 'MaChiTietSanPham', caption: 'Mã SKU', width: 120, allowEditing: false },
                    { dataField: 'TenChiTietSanPham', caption: 'Diễn giải', width: 220, allowEditing: false },
                    { dataField: 'MaKeCu', caption: 'Từ kệ', width: 100, allowEditing: false },
                    { dataField: 'SoLuong', caption: 'Số lượng', width: 100, allowEditing: false },
                    {
                        dataField: 'MaKeMoi',
                        caption: 'Đến kệ',
                        width: 100,
                    },
                    { dataField: 'SoLuong', caption: 'Số lượng', width: 100, allowEditing: false },
                    { dataField: 'HoTen', caption: 'Người chuyển', width: 100, allowEditing: false },
                    { dataField: 'NgayChuyen', caption: 'Ngày chuyển', width: 100, allowEditing: false },
                ],
            });
        });
        
    }
    function Refresh() {
        NguoiChuyen = $("#select-nguoidung").dxDropDownBox("instance").option('value');
        masku = $("#txt-masku").dxTextBox("instance").option('value');
        masp = $("#txt-masp").dxTextBox("instance").option('value');
        tungay = Globalize.format($("#date-tungay").dxDateBox("instance").option('value'), 'yyyy-MM-dd');
        denngay = Globalize.format($("#date-denngay").dxDateBox("instance").option('value'), 'yyyy-MM-dd');
        loadReport();
    }
</script>
}